<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Upload - WebGlo Project Assets</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center">
  <div class="max-w-md w-full bg-white rounded-lg shadow-lg p-8">
    <h1 class="text-2xl font-bold text-center mb-6">Upload Project Assets</h1>
    
    <div class="mb-4">
      <label for="order-number" class="block text-sm font-medium text-gray-700 mb-2">Order Number</label>
      <input type="text" id="order-number" placeholder="LPE-2025-0001" 
             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>
    
    <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-2">Select Files</label>
      <input type="file" id="file-input" multiple 
             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>
    
    <button onclick="authenticateAndUpload()" 
            class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
      Upload to Google Drive
    </button>
    
    <div id="status" class="mt-4 text-center"></div>
  </div>

  <script>
    // Google Drive API configuration
    const API_KEY = 'YOUR_GOOGLE_API_KEY';
    const CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC],
      });
      gapiInited = true;
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '',
      });
      gisInited = true;
    }

    function authenticateAndUpload() {
      if (!gapiInited || !gisInited) {
        document.getElementById('status').innerHTML = '<p class="text-red-600">Google APIs not loaded. Please refresh and try again.</p>';
        return;
      }

      const orderNumber = document.getElementById('order-number').value;
      const files = document.getElementById('file-input').files;

      if (!orderNumber) {
        document.getElementById('status').innerHTML = '<p class="text-red-600">Please enter your order number.</p>';
        return;
      }

      if (files.length === 0) {
        document.getElementById('status').innerHTML = '<p class="text-red-600">Please select files to upload.</p>';
        return;
      }

      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
          throw (resp);
        }
        await uploadFiles(orderNumber, files);
      };

      if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
      } else {
        tokenClient.requestAccessToken({prompt: ''});
      }
    }

    async function uploadFiles(orderNumber, files) {
      document.getElementById('status').innerHTML = '<p class="text-blue-600">Uploading files...</p>';

      try {
        // Find the customer folder
        const folderName = orderNumber;
        const folders = await gapi.client.drive.files.list({
          q: `name contains '${folderName}' and mimeType='application/vnd.google-apps.folder'`,
          fields: 'files(id, name)'
        });

        if (folders.result.files.length === 0) {
          document.getElementById('status').innerHTML = '<p class="text-red-600">Customer folder not found. Please contact support.</p>';
          return;
        }

        const customerFolderId = folders.result.files[0].id;

        // Find the assets subfolder
        const subfolders = await gapi.client.drive.files.list({
          q: `'${customerFolderId}' in parents and name='01-Assets-Provided' and mimeType='application/vnd.google-apps.folder'`,
          fields: 'files(id, name)'
        });

        const assetsFolderId = subfolders.result.files[0].id;

        // Upload each file
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          document.getElementById('status').innerHTML = `<p class="text-blue-600">Uploading ${file.name} (${i + 1}/${files.length})...</p>`;

          const metadata = {
            name: file.name,
            parents: [assetsFolderId]
          };

          const form = new FormData();
          form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
          form.append('file', file);

          await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: new Headers({
              'Authorization': `Bearer ${gapi.client.getToken().access_token}`
            }),
            body: form
          });
        }

        document.getElementById('status').innerHTML = '<p class="text-green-600">âœ… All files uploaded successfully!</p>';

      } catch (error) {
        console.error('Upload error:', error);
        document.getElementById('status').innerHTML = '<p class="text-red-600">Upload failed. Please try again or contact support.</p>';
      }
    }

    // Load the APIs
    gapiLoaded();
    gisLoaded();
  </script>
</body>
</html>
