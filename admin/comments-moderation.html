<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BFDSVY8Y4N"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-BFDSVY8Y4N');
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comment Moderation Dashboard | WebGlo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-gray-50 font-inter">
  <!-- Header -->
  <header class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <img src="assets/logo.png" alt="WebGlo" class="w-8 h-8 mr-3">
          <h1 class="text-xl font-bold text-gray-900">Comment Moderation</h1>
        </div>
        <div class="flex items-center gap-4">
          <div class="stats-summary flex items-center gap-6 text-sm text-gray-600">
            <span>Pending: <span id="pending-count" class="font-semibold text-orange-600">-</span></span>
            <span>Total: <span id="total-count" class="font-semibold">-</span></span>
          </div>
          <button id="refresh-btn" class="bg-[#df00ff] text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors">
            Refresh
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-6 py-8">
    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Filters</h2>
      <div class="flex flex-wrap gap-4">
        <select id="status-filter" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-[#df00ff] focus:border-[#df00ff]">
          <option value="">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
        <input 
          type="text" 
          id="search-input" 
          placeholder="Search comments..." 
          class="border border-gray-300 rounded-lg px-4 py-2 flex-1 focus:ring-2 focus:ring-[#df00ff] focus:border-[#df00ff]"
        >
        <input 
          type="text" 
          id="post-filter" 
          placeholder="Filter by post ID..." 
          class="border border-gray-300 rounded-lg px-4 py-2 w-48 focus:ring-2 focus:ring-[#df00ff] focus:border-[#df00ff]"
        >
      </div>
    </div>

    <!-- Admin Key Input -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-8">
      <h3 class="text-sm font-medium text-yellow-800 mb-2">Admin Access Required</h3>
      <input 
        type="password" 
        id="admin-key" 
        placeholder="Enter admin key..." 
        class="border border-yellow-300 rounded-lg px-4 py-2 w-64 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500"
      >
      <p class="text-xs text-yellow-700 mt-1">This key is required to moderate comments</p>
    </div>

    <!-- Comments List -->
    <div class="space-y-6" id="comments-container">
      <div class="text-center py-12 text-gray-500">
        <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
        </svg>
        <p>Load comments to begin moderation</p>
      </div>
    </div>

    <!-- Load More -->
    <div class="text-center mt-8">
      <button id="load-more" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition-colors hidden">
        Load More Comments
      </button>
    </div>
  </main>

  <!-- Comment Modal -->
  <div id="comment-modal" class="fixed inset-0 bg-black/50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
        <div class="p-6 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">Comment Details</h3>
        </div>
        <div class="p-6 max-h-96 overflow-y-auto" id="modal-content">
          <!-- Modal content will be inserted here -->
        </div>
        <div class="p-6 border-t border-gray-200 flex justify-end gap-3">
          <button id="modal-close" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">Cancel</button>
          <button id="modal-approve" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">Approve</button>
          <button id="modal-reject" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">Reject</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    class CommentModerationDashboard {
      constructor() {
        this.apiUrl = 'https://script.google.com/macros/s/YOUR_COMMENTS_SCRIPT_ID/exec';
        this.comments = [];
        this.filteredComments = [];
        this.currentComment = null;
        this.adminKey = '';
        this.page = 0;
        this.pageSize = 20;
        
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.loadComments();
      }

      setupEventListeners() {
        // Refresh button
        document.getElementById('refresh-btn').addEventListener('click', () => {
          this.loadComments();
        });

        // Filters
        document.getElementById('status-filter').addEventListener('change', () => {
          this.applyFilters();
        });
        
        document.getElementById('search-input').addEventListener('input', () => {
          this.applyFilters();
        });
        
        document.getElementById('post-filter').addEventListener('input', () => {
          this.applyFilters();
        });

        // Admin key
        document.getElementById('admin-key').addEventListener('input', (e) => {
          this.adminKey = e.target.value;
        });

        // Modal
        document.getElementById('modal-close').addEventListener('click', () => {
          this.closeModal();
        });
        
        document.getElementById('modal-approve').addEventListener('click', () => {
          this.moderateComment('approve');
        });
        
        document.getElementById('modal-reject').addEventListener('click', () => {
          this.moderateComment('reject');
        });

        // Click outside modal to close
        document.getElementById('comment-modal').addEventListener('click', (e) => {
          if (e.target.id === 'comment-modal') {
            this.closeModal();
          }
        });
      }

      async loadComments() {
        try {
          this.showLoading();
          
          if (!this.adminKey) {
            this.showError('Please enter your admin key first');
            return;
          }
          
          // Load all comments for moderation
          const response = await fetch(`${this.apiUrl}?path=list&adminKey=${encodeURIComponent(this.adminKey)}&origin=${encodeURIComponent(window.location.origin)}`);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const data = await response.json();
          
          if (data.success) {
            this.comments = data.comments || [];
            this.applyFilters();
            this.updateStats();
          } else {
            throw new Error(data.error || 'Failed to load comments');
          }
          
        } catch (error) {
          console.error('Error loading comments:', error);
          this.showError('Failed to load comments: ' + error.message);
        }
      }

      updateStats() {
        const pending = this.comments.filter(c => c.status === 'pending').length;
        const total = this.comments.length;
        
        document.getElementById('pending-count').textContent = pending;
        document.getElementById('total-count').textContent = total;
      }

      async loadAllComments() {
        // This function is no longer needed as loadComments handles everything
        return;
      }

      updateStats(stats) {
        document.getElementById('pending-count').textContent = stats.pending || 0;
        document.getElementById('total-count').textContent = stats.total || 0;
      }

      applyFilters() {
        const statusFilter = document.getElementById('status-filter').value;
        const searchQuery = document.getElementById('search-input').value.toLowerCase();
        const postFilter = document.getElementById('post-filter').value.toLowerCase();

        this.filteredComments = this.comments.filter(comment => {
          const matchesStatus = !statusFilter || comment.status === statusFilter;
          const matchesSearch = !searchQuery || 
            comment.content.toLowerCase().includes(searchQuery) ||
            comment.author.toLowerCase().includes(searchQuery);
          const matchesPost = !postFilter || comment.postId.toLowerCase().includes(postFilter);
          
          return matchesStatus && matchesSearch && matchesPost;
        });

        this.renderComments();
      }

      renderComments() {
        const container = document.getElementById('comments-container');
        
        if (this.filteredComments.length === 0) {
          container.innerHTML = `
            <div class="text-center py-12 text-gray-500">
              <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
              </svg>
              <p>No comments found matching your filters</p>
            </div>
          `;
          return;
        }

        const commentsHTML = this.filteredComments
          .slice(0, (this.page + 1) * this.pageSize)
          .map(comment => this.generateCommentCard(comment))
          .join('');
        
        container.innerHTML = commentsHTML;
        
        // Show/hide load more button
        const loadMoreBtn = document.getElementById('load-more');
        if (this.filteredComments.length > (this.page + 1) * this.pageSize) {
          loadMoreBtn.classList.remove('hidden');
        } else {
          loadMoreBtn.classList.add('hidden');
        }
      }

      generateCommentCard(comment) {
        const statusColor = {
          pending: 'bg-orange-100 text-orange-800 border-orange-200',
          approved: 'bg-green-100 text-green-800 border-green-200',
          rejected: 'bg-red-100 text-red-800 border-red-200'
        };

        return `
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 comment-card" data-comment-id="${comment.id}">
            <div class="flex items-start justify-between mb-4">
              <div class="flex items-center">
                <div class="w-10 h-10 bg-gradient-to-r from-[#df00ff] to-[#0cead9] rounded-full flex items-center justify-center text-white font-bold">
                  ${comment.author.charAt(0).toUpperCase()}
                </div>
                <div class="ml-3">
                  <div class="font-semibold text-gray-900">${this.escapeHtml(comment.author)}</div>
                  <div class="text-sm text-gray-500">${comment.email}</div>
                  <div class="text-xs text-gray-400">${new Date(comment.timestamp).toLocaleString()}</div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <span class="px-3 py-1 rounded-full text-xs font-medium border ${statusColor[comment.status] || statusColor.pending}">
                  ${comment.status}
                </span>
                <button class="view-details-btn text-[#df00ff] hover:text-purple-600 transition-colors" data-comment-id="${comment.id}">
                  View Details
                </button>
              </div>
            </div>
            
            <div class="mb-4">
              <div class="text-sm text-gray-600 mb-2">
                <strong>Post:</strong> ${comment.postId}
                ${comment.parentId ? `<br><strong>Reply to:</strong> ${comment.parentId}` : ''}
              </div>
              <div class="text-gray-800 line-clamp-3">
                ${this.escapeHtml(comment.content)}
              </div>
            </div>
            
            ${comment.status === 'pending' ? `
              <div class="flex items-center gap-3 pt-4 border-t border-gray-200">
                <button class="approve-btn bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors" data-comment-id="${comment.id}">
                  Approve
                </button>
                <button class="reject-btn bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors" data-comment-id="${comment.id}">
                  Reject
                </button>
              </div>
            ` : ''}
          </div>
        `;
      }

      showCommentDetails(commentId) {
        const comment = this.comments.find(c => c.id === commentId);
        if (!comment) return;

        this.currentComment = comment;
        
        const modalContent = document.getElementById('modal-content');
        modalContent.innerHTML = `
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Author</label>
              <div class="text-gray-900">${this.escapeHtml(comment.author)} (${comment.email})</div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Post ID</label>
              <div class="text-gray-900">${comment.postId}</div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Timestamp</label>
              <div class="text-gray-900">${new Date(comment.timestamp).toLocaleString()}</div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Content</label>
              <div class="text-gray-900 whitespace-pre-wrap bg-gray-50 p-4 rounded-lg border">
                ${this.escapeHtml(comment.content)}
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Metadata</label>
              <div class="text-sm text-gray-600 bg-gray-50 p-4 rounded-lg border">
                <div><strong>IP:</strong> ${comment.ipAddress || 'N/A'}</div>
                <div><strong>User Agent:</strong> ${comment.userAgent || 'N/A'}</div>
                <div><strong>Status:</strong> ${comment.status}</div>
                ${comment.parentId ? `<div><strong>Parent ID:</strong> ${comment.parentId}</div>` : ''}
              </div>
            </div>
          </div>
        `;
        
        document.getElementById('comment-modal').classList.remove('hidden');
      }

      closeModal() {
        document.getElementById('comment-modal').classList.add('hidden');
        this.currentComment = null;
      }

      async moderateComment(action) {
        if (!this.currentComment) return;
        
        if (!this.adminKey) {
          alert('Please enter your admin key first');
          return;
        }

        try {
          const response = await fetch(`${this.apiUrl}?path=moderate&commentId=${this.currentComment.id}&action=${action}&adminKey=${this.adminKey}&origin=${encodeURIComponent(window.location.origin)}`);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const result = await response.json();
          
          if (result.success) {
            // Update comment status locally
            this.currentComment.status = action === 'approve' ? 'approved' : 'rejected';
            this.closeModal();
            this.renderComments();
            this.loadComments(); // Refresh stats
            
            this.showSuccess(`Comment ${action}d successfully`);
          } else {
            throw new Error(result.error || 'Moderation failed');
          }
          
        } catch (error) {
          console.error('Error moderating comment:', error);
          this.showError('Failed to moderate comment: ' + error.message);
        }
      }

      showLoading() {
        const container = document.getElementById('comments-container');
        container.innerHTML = `
          <div class="text-center py-12">
            <div class="inline-flex items-center">
              <svg class="animate-spin w-5 h-5 mr-3 text-[#df00ff]" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Loading comments...
            </div>
          </div>
        `;
      }

      showError(message) {
        this.showMessage(message, 'error');
      }

      showSuccess(message) {
        this.showMessage(message, 'success');
      }

      showMessage(message, type) {
        // Simple toast notification
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
          type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
        }`;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.remove();
        }, 5000);
      }

      async moderateCommentById(commentId, action) {
        if (!this.adminKey) {
          alert('Please enter your admin key first');
          return;
        }

        try {
          const response = await fetch(`${this.apiUrl}?path=moderate&commentId=${commentId}&action=${action}&adminKey=${encodeURIComponent(this.adminKey)}&origin=${encodeURIComponent(window.location.origin)}`);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const result = await response.json();
          
          if (result.success) {
            // Update comment status locally
            const comment = this.comments.find(c => c.id === commentId);
            if (comment) {
              comment.status = action === 'approve' ? 'approved' : 'rejected';
            }
            
            this.applyFilters();
            this.updateStats();
            
            this.showSuccess(`Comment ${action}d successfully`);
          } else {
            throw new Error(result.error || 'Moderation failed');
          }
          
        } catch (error) {
          console.error('Error moderating comment:', error);
          this.showError('Failed to moderate comment: ' + error.message);
        }
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
      window.moderationDashboard = new CommentModerationDashboard();
    });

    // Handle quick moderation buttons
    document.addEventListener('click', async (e) => {
      if (e.target.classList.contains('approve-btn') || e.target.classList.contains('reject-btn')) {
        e.preventDefault();
        const commentId = e.target.dataset.commentId;
        const action = e.target.classList.contains('approve-btn') ? 'approve' : 'reject';
        
        if (confirm(`Are you sure you want to ${action} this comment?`)) {
          await window.moderationDashboard.moderateCommentById(commentId, action);
        }
      }
      
      if (e.target.classList.contains('view-details-btn')) {
        e.preventDefault();
        const commentId = e.target.dataset.commentId;
        window.moderationDashboard.showCommentDetails(commentId);
      }
    });
  </script>
</body>
</html>
